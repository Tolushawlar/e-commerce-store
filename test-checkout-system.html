<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout System Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-5xl mx-auto">
        <h1 class="text-3xl font-bold mb-8">Checkout & Order System Test</h1>

        <!-- Address Management -->
        <div class="bg-white p-6 rounded-lg shadow mb-6">
            <h2 class="text-xl font-semibold mb-4">1. Address Management</h2>
            
            <div class="mb-4">
                <button onclick="getAddresses()" class="bg-blue-500 text-white px-4 py-2 rounded mr-2">Get Addresses</button>
                <button onclick="showAddressForm()" class="bg-green-500 text-white px-4 py-2 rounded">Add Address</button>
            </div>

            <div id="address-form" class="hidden space-y-3 mb-4">
                <h3 class="font-semibold">New Address</h3>
                <input type="text" id="addr-name" placeholder="Full Name" class="w-full border p-2 rounded">
                <input type="text" id="addr-phone" placeholder="Phone" class="w-full border p-2 rounded">
                <input type="text" id="addr-line1" placeholder="Address Line 1" class="w-full border p-2 rounded">
                <input type="text" id="addr-city" placeholder="City" class="w-full border p-2 rounded">
                <input type="text" id="addr-state" placeholder="State" class="w-full border p-2 rounded">
                <button onclick="createAddress()" class="bg-green-500 text-white px-4 py-2 rounded">Save Address</button>
            </div>

            <pre id="addresses-result" class="mt-4 bg-gray-100 p-3 rounded text-sm max-h-60 overflow-auto"></pre>
        </div>

        <!-- Guest Checkout -->
        <div class="bg-white p-6 rounded-lg shadow mb-6">
            <h2 class="text-xl font-semibold mb-4">2. Guest Checkout</h2>
            <div class="space-y-3">
                <input type="text" id="guest-name" placeholder="Full Name" class="w-full border p-2 rounded">
                <input type="email" id="guest-email" placeholder="Email" class="w-full border p-2 rounded">
                <input type="text" id="guest-phone" placeholder="Phone" class="w-full border p-2 rounded">
                <input type="text" id="guest-address" placeholder="Address" class="w-full border p-2 rounded">
                <input type="text" id="guest-city" placeholder="City" class="w-full border p-2 rounded">
                <input type="text" id="guest-state" placeholder="State" class="w-full border p-2 rounded">
                
                <div>
                    <label class="font-semibold">Products (comma-separated IDs:Quantity)</label>
                    <input type="text" id="guest-products" placeholder="e.g., 1:2,3:1" class="w-full border p-2 rounded">
                    <small class="text-gray-600">Format: product_id:quantity,product_id:quantity</small>
                </div>

                <select id="guest-payment" class="w-full border p-2 rounded">
                    <option value="cash_on_delivery">Cash on Delivery</option>
                    <option value="bank_transfer">Bank Transfer</option>
                    <option value="card">Card</option>
                </select>

                <button onclick="guestCheckout()" class="bg-orange-500 text-white px-4 py-2 rounded">Place Order (Guest)</button>
            </div>
            <pre id="guest-checkout-result" class="mt-4 bg-gray-100 p-3 rounded text-sm max-h-60 overflow-auto"></pre>
        </div>

        <!-- Registered Customer Checkout -->
        <div class="bg-white p-6 rounded-lg shadow mb-6">
            <h2 class="text-xl font-semibold mb-4">3. Checkout from Cart (Registered)</h2>
            <div class="space-y-3">
                <input type="text" id="checkout-name" placeholder="Full Name" class="w-full border p-2 rounded">
                <input type="email" id="checkout-email" placeholder="Email" class="w-full border p-2 rounded">
                <input type="text" id="checkout-phone" placeholder="Phone" class="w-full border p-2 rounded">
                <input type="number" id="checkout-address-id" placeholder="Address ID (optional)" class="w-full border p-2 rounded">
                <input type="number" id="shipping-cost" placeholder="Shipping Cost" value="2000" class="w-full border p-2 rounded">
                
                <select id="checkout-payment" class="w-full border p-2 rounded">
                    <option value="cash_on_delivery">Cash on Delivery</option>
                    <option value="bank_transfer">Bank Transfer</option>
                    <option value="card">Card</option>
                </select>

                <textarea id="order-notes" placeholder="Delivery notes (optional)" class="w-full border p-2 rounded" rows="2"></textarea>

                <button onclick="checkoutFromCart()" class="bg-purple-500 text-white px-4 py-2 rounded">Checkout from Cart</button>
            </div>
            <pre id="checkout-result" class="mt-4 bg-gray-100 p-3 rounded text-sm max-h-60 overflow-auto"></pre>
        </div>

        <!-- View Orders -->
        <div class="bg-white p-6 rounded-lg shadow mb-6">
            <h2 class="text-xl font-semibold mb-4">4. View Orders</h2>
            <button onclick="getOrders()" class="bg-teal-500 text-white px-4 py-2 rounded">Get My Orders</button>
            <pre id="orders-result" class="mt-4 bg-gray-100 p-3 rounded text-sm max-h-60 overflow-auto"></pre>
        </div>

        <!-- Track Order -->
        <div class="bg-white p-6 rounded-lg shadow mb-6">
            <h2 class="text-xl font-semibold mb-4">5. Track Order (No Login Required)</h2>
            <div class="space-y-3">
                <input type="number" id="track-order-id" placeholder="Order ID" class="w-full border p-2 rounded">
                <input type="email" id="track-email" placeholder="Email used for order" class="w-full border p-2 rounded">
                <button onclick="trackOrder()" class="bg-indigo-500 text-white px-4 py-2 rounded">Track Order</button>
            </div>
            <pre id="track-result" class="mt-4 bg-gray-100 p-3 rounded text-sm max-h-60 overflow-auto"></pre>
        </div>

        <!-- Token Display -->
        <div class="bg-yellow-100 p-4 rounded-lg">
            <p class="font-semibold">Current Token:</p>
            <p id="current-token" class="text-xs break-all mt-2">No token - Login from customer test page first</p>
            <button onclick="clearToken()" class="mt-2 bg-red-500 text-white px-3 py-1 rounded text-sm">Clear Token</button>
        </div>
    </div>

    <script>
        const STORE_ID = 1; // Change to your store ID
        const API_BASE = 'http://localhost:8000';

        let token = localStorage.getItem('customer_token');
        updateTokenDisplay();

        function updateTokenDisplay() {
            document.getElementById('current-token').textContent = token || 'No token - Login required for some features';
        }

        function clearToken() {
            localStorage.removeItem('customer_token');
            token = null;
            updateTokenDisplay();
            alert('Token cleared. You can now test guest features.');
        }

        function showAddressForm() {
            document.getElementById('address-form').classList.toggle('hidden');
        }

        async function getAddresses() {
            if (!token) {
                alert('Please login first!');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/stores/${STORE_ID}/addresses`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();
                document.getElementById('addresses-result').textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                document.getElementById('addresses-result').textContent = 'Error: ' + error.message;
            }
        }

        async function createAddress() {
            if (!token) {
                alert('Please login first!');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/stores/${STORE_ID}/addresses`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        full_name: document.getElementById('addr-name').value,
                        phone: document.getElementById('addr-phone').value,
                        address_line1: document.getElementById('addr-line1').value,
                        city: document.getElementById('addr-city').value,
                        state: document.getElementById('addr-state').value,
                        country: 'Nigeria'
                    })
                });

                const data = await response.json();
                document.getElementById('addresses-result').textContent = JSON.stringify(data, null, 2);
                
                if (data.success) {
                    alert('Address created!');
                    document.getElementById('address-form').classList.add('hidden');
                }
            } catch (error) {
                document.getElementById('addresses-result').textContent = 'Error: ' + error.message;
            }
        }

        async function guestCheckout() {
            const productsInput = document.getElementById('guest-products').value;
            const products = productsInput.split(',').map(item => {
                const [id, qty] = item.split(':');
                return { product_id: parseInt(id), quantity: parseInt(qty) };
            });

            try {
                const response = await fetch(`${API_BASE}/api/stores/${STORE_ID}/checkout`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        customer_name: document.getElementById('guest-name').value,
                        customer_email: document.getElementById('guest-email').value,
                        customer_phone: document.getElementById('guest-phone').value,
                        payment_method: document.getElementById('guest-payment').value,
                        shipping_cost: 2000,
                        items: products,
                        shipping_address: {
                            full_name: document.getElementById('guest-name').value,
                            phone: document.getElementById('guest-phone').value,
                            address_line1: document.getElementById('guest-address').value,
                            city: document.getElementById('guest-city').value,
                            state: document.getElementById('guest-state').value,
                            country: 'Nigeria'
                        }
                    })
                });

                const data = await response.json();
                document.getElementById('guest-checkout-result').textContent = JSON.stringify(data, null, 2);

                if (data.success) {
                    alert(`Order placed! Order ID: ${data.data.id}`);
                }
            } catch (error) {
                document.getElementById('guest-checkout-result').textContent = 'Error: ' + error.message;
            }
        }

        async function checkoutFromCart() {
            if (!token) {
                alert('Please login first and add items to cart!');
                return;
            }

            const addressId = document.getElementById('checkout-address-id').value;

            try {
                const response = await fetch(`${API_BASE}/api/stores/${STORE_ID}/checkout`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        customer_name: document.getElementById('checkout-name').value,
                        customer_email: document.getElementById('checkout-email').value,
                        customer_phone: document.getElementById('checkout-phone').value,
                        shipping_address_id: addressId ? parseInt(addressId) : undefined,
                        payment_method: document.getElementById('checkout-payment').value,
                        shipping_cost: parseFloat(document.getElementById('shipping-cost').value),
                        notes: document.getElementById('order-notes').value
                    })
                });

                const data = await response.json();
                document.getElementById('checkout-result').textContent = JSON.stringify(data, null, 2);

                if (data.success) {
                    alert(`Order placed! Order ID: ${data.data.id}`);
                }
            } catch (error) {
                document.getElementById('checkout-result').textContent = 'Error: ' + error.message;
            }
        }

        async function getOrders() {
            if (!token) {
                alert('Please login first!');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/stores/${STORE_ID}/orders`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();
                document.getElementById('orders-result').textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                document.getElementById('orders-result').textContent = 'Error: ' + error.message;
            }
        }

        async function trackOrder() {
            const orderId = document.getElementById('track-order-id').value;
            const email = document.getElementById('track-email').value;

            try {
                const response = await fetch(
                    `${API_BASE}/api/stores/${STORE_ID}/orders/track?order_id=${orderId}&email=${encodeURIComponent(email)}`
                );

                const data = await response.json();
                document.getElementById('track-result').textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                document.getElementById('track-result').textContent = 'Error: ' + error.message;
            }
        }
    </script>
</body>
</html>
